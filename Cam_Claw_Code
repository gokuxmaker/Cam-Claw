#include "esp_camera.h"

#include <WiFi.h>

#include <WebServer.h>

#include <ESP32Servo.h>

// ====== CAMERA SETTINGS (XIAO ESP32S3 Sense + OV3660) ======

#define PWDN_GPIO_NUM -1

define RESET_GPIO_NUM -1

#define XCLK_GPIO_NUM10

#define SIOD_GPIO_NUM40

#define SIOC_GPIO_NUM39

#define Y9_GPIO_NUM48

#efine Y8_GPIO_NUM11

#define Y7_GPIO_NUM12

#define Y6_GPIO_NUM14

#define Y5_GPIO_NUM16

#define Y4_GPIO_NUM18

#define Y3_GPIO_NUM17

#define Y2_GPIO_NUM15

#define VSYNC_GPIO_NUM38

#define HREF_GPIO_NUM47

#define PCLK_GPIO_NUM13

// ====== SERVO SETTINGS ======

Servo clawServo;

int servoPin = D0; // D0 on XIAO ESP32S3 = GPIO2

constint GRAB_ANGLE = -5;

constint RELEASE_ANGLE = 170;

// ====== WIFI SETTINGS ======

constchar* ssid = "CamClaw";

constchar* password = "12345678";

WebServer server(80);

// ====== MODERN HTML PAGE ======

String htmlPage = R"rawliteral(

<!DOCTYPE html>

<html>

<head>

<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />

<title>Cam Claw</title>

<style>

:root{

--bg:#f4f7fb; --card:#ffffff; --accent:#ff5a5a; --blue:#2a9dff; --text:#222;

}

html,body{height:100%; margin:0; font-family: 'Segoe UI', Arial, sans-serif; background:var(--bg);}

.wrap{max-width:820px; margin:20px auto; padding:20px; text-align:center; color:var(--text);}

h1{margin:10px 0 18px; font-size:26px; font-weight:600;}

.card{background:var(--card); border-radius:14px; padding:16px; box-shadow:0 6px 20px rgba(0,0,0,0.1);}

#cam { width:100%; max-width:720px; border-radius:10px; display:block; margin: 10px auto; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }

.buttons{display:flex; gap:14px; justify-content:center; flex-wrap:wrap; margin-top:16px;}

.btn{

min-width:180px;

padding:20px 26px;

font-size:20px;

border-radius:14px;

border:none;

cursor:pointer;

box-shadow: 0 4px 12px rgba(0,0,0,0.15);

color:#fff;

transition:transform .12s ease, box-shadow .12s ease;

}

.grab{ background: linear-gradient(180deg,var(--accent),#ff2a2a); }

.release{ background: linear-gradient(180deg,var(--blue),#0077ff); }

.btn:active{ transform:scale(0.96); box-shadow:0 2px 6px rgba(0,0,0,0.2); }

#status{ color:#444; margin-top:12px; font-size:16px; font-weight:500;}

</style>

</head>

<body>

<div class="wrap">

<h1>CAM CALW</h1>

<div class="card">

<img id="cam" src="/capture?ts=0" alt="camera">

<div class="buttons">

<button class="btn grab" onclick="doAction('grab')">Grab</button>

<button class="btn release" onclick="doAction('release')">Release</button>

</div>

<div id="status">Status: idle</div>

</div>

</div>

<script>

const cam = document.getElementById('cam');

const status = document.getElementById('status');

setInterval(()=> { cam.src = '/capture?ts=' + Date.now(); }, 100);

function doAction(act) {

status.innerText = 'Status: ' + act + '...';

fetch('/' + act)

.then(r => r.json())

.then(j => status.innerText = 'Status: ' + j.status + ' (angle=' + j.position + ')')

.catch(e => status.innerText = 'Status: error');

}

</script>

</body>

</html>

)rawliteral";

// ====== HANDLERS ======

voidhandle_root() { server.send(200, "text/html", htmlPage); }

voidhandle_capture() {

camera_fb_t * fb = esp_camera_fb_get();

if (!fb) {

server.send(500, "text/plain", "Camera capture failed");

return;

}

server.sendHeader("Content-Type", "image/jpeg");

server.sendHeader("Cache-Control", "no-store");

WiFiClient client = server.client();

client.write((constchar*)fb->buf, fb->len);

esp_camera_fb_return(fb);

}

voidhandle_grab() {

clawServo.write(GRAB_ANGLE);

String payload = String("{\"status\":\"Grabbed\",\"position\":") + GRAB_ANGLE + "}";

server.send(200, "application/json", payload);

}

voidhandle_release() {

clawServo.write(RELEASE_ANGLE);

String payload = String("{\"status\":\"Released\",\"position\":") + RELEASE_ANGLE + "}";

server.send(200, "application/json", payload);

}

// ====== SETUP ======

voidsetup() {

Serial.begin(115200);

delay(100);

// Enable camera power (needed on XIAO ESP32S3 Sense)

pinMode(21, OUTPUT);

digitalWrite(21, HIGH);

delay(10);

// Servo init

ESP32PWM::allocateTimer(0);

ESP32PWM::allocateTimer(1);

ESP32PWM::allocateTimer(2);

ESP32PWM::allocateTimer(3);

clawServo.setPeriodHertz(50);

clawServo.attach(servoPin, 500, 2400);

clawServo.write(RELEASE_ANGLE);

// Camera config

camera_config_t config;

config.ledc_channel = LEDC_CHANNEL_0;

config.ledc_timer = LEDC_TIMER_0;

config.pin_d0 = Y2_GPIO_NUM;

config.pin_d1 = Y3_GPIO_NUM;

config.pin_d2 = Y4_GPIO_NUM;

config.pin_d3 = Y5_GPIO_NUM;

config.pin_d4 = Y6_GPIO_NUM;

config.pin_d5 = Y7_GPIO_NUM;

config.pin_d6 = Y8_GPIO_NUM;

config.pin_d7 = Y9_GPIO_NUM;

config.pin_xclk = XCLK_GPIO_NUM;

config.pin_pclk = PCLK_GPIO_NUM;

config.pin_vsync = VSYNC_GPIO_NUM;

config.pin_href = HREF_GPIO_NUM;

config.pin_sscb_sda = SIOD_GPIO_NUM;

config.pin_sscb_scl = SIOC_GPIO_NUM;

config.pin_pwdn = PWDN_GPIO_NUM;

config.pin_reset = RESET_GPIO_NUM;

config.xclk_freq_hz = 20000000;

config.pixel_format = PIXFORMAT_JPEG;

config.frame_size = FRAMESIZE_QVGA;

config.jpeg_quality = 10;

config.fb_count = 2;

if (esp_camera_init(&config) != ESP_OK) {

Serial.println("Camera init failed!");

while (true) delay(1000);

}

sensor_t * s = esp_camera_sensor_get();

s->set_vflip(s, 1);

s->set_hmirror(s, 1);

// Start AP

WiFi.softAP(ssid, password);

Serial.printf("AP started: SSID=%s IP=%s\n", ssid, WiFi.softAPIP().toString().c_str());

// Routes

server.on("/", HTTP_GET, handle_root);

server.on("/capture", HTTP_GET, handle_capture);

server.on("/grab", HTTP_GET, handle_grab);

server.on("/release", HTTP_GET, handle_release);

server.begin();

}

voidloop() {

server.handleClient();

}
